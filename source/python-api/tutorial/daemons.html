
<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Daemons &#8212; iTerm2 Python API 0.26 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  </head><body>
  <header >
    <div class="row">
      <div class="small-12 medium-12 large-10 large-centered columns wide-row">
        <div class="text-center"><a href="/index.html"><img src="https://iterm2.com/img/logo2x.jpg" width=800 height=312></a></div>
        <div class="sticky contain-to-grid">
          <nav class="top-bar" data-topbar>
            <ul class="title-area">
              <li class="name">

              </li>
              <li class="toggle-topbar menu-icon"><a href="#">Menu</a></li>
              <li class="small-screen-donate">
		  <a href="/donate.html"><img src="https://iterm2.com/images/DonateButton.png" width="92" height="26"></a>
                </li>
            </ul>

            <section class="top-bar-section">
              <!-- Right Nav Section -->
              <ul class="right"> <li>
		  <a href="/donate.html"><img src="https://iterm2.com/images/DonateButton.png" width="92" height="26"></a>
                </li>
              </ul>
            </li>
          </ul>

          <!-- Left Nav Section -->
          <ul class="left">
            <li><a href="/index.html">Home</a></li>
            <li ><a href="/news.html">News</a></li>
            <li ><a href="/features.html">Features</a></li>
            <li ><a href="/faq.html">FAQ</a></li>
            <li class="active"><a href="/documentation.html">Documentation</a></li>
            <li ><a href="/downloads.html">Downloads</a></li>
          </ul>
        </section>
      </nav>
    </div>
  </div>
</div>
</header>




    <div class="document">
<div class="row">
  <div class="small-12 medium-12 large-10 large-centered columns wide-row">
    <div class="main panel">

      <div class="doc-wrapper">
	<a href="#" data-dropdown="drop-menu">Table of Contents</a>
	<div id="drop-menu" data-dropdown-content class="f-dropdown content">
	  <div class="inner-menu">
	    <ul class="sub-nav">
	      <div class="toc_subhead">iTerm2</div>

	      <li><a href="/documentation.html">iTerm2 Documentation</a></li>

	      <div class="toc_subhead">Python API</div>

	      <li><a href="/python-api">Python API</a></li>
	      <li><a href="/python-api/tutorial/index.html">Tutorial</a></li>
	      <li><a href="/python-api/examples/index.html">Examples</a></li>

	    </ul>
	  </div>
	</div>
      </div>

<hr/>

      <div class="documentwrapper">
	<div class="bodywrapper">
	  <div class="body" role="main">
	    
  <div class="section" id="daemons">
<h1>Daemons<a class="headerlink" href="#daemons" title="Permalink to this headline">¶</a></h1>
<p>A daemon in the Unix tradition is a computer program that runs as a background
process, rather than being under the direct control of an interactive user.</p>
<p>An iTerm2 daemon would ordinarily be an AutoLaunch script that provides some
service, such as listening for notifications and reacting to them. Autolaunch
scripts should be placed in <cite>~/Library/Application Support/iTerm2/Scripts/AutoLaunch</cite>.</p>
<p>AutoLaunch scripts are launched at startup. When you create a new one it does
not get launched until iTerm2 is restarted, but you can always run it by
selecting it from the <strong>Scripts</strong> menu.</p>
<p>When you create a new script and choose to make it a “Long-Running Daemon” (as
opposed to a “Simple” script), iTerm2 will provide a sample program to help you
get started:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">iterm2</span>

<span class="n">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
    <span class="n">async</span> <span class="k">with</span> <span class="n">iterm2</span><span class="o">.</span><span class="n">CustomControlSequenceMonitor</span><span class="p">(</span>
            <span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;shared-secret&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;^create-window$&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mon</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">await</span> <span class="n">mon</span><span class="o">.</span><span class="n">async_get</span><span class="p">()</span>
            <span class="n">await</span> <span class="n">iterm2</span><span class="o">.</span><span class="n">Window</span><span class="o">.</span><span class="n">async_create</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

<span class="n">iterm2</span><span class="o">.</span><span class="n">run_forever</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>Skipping the boilerplate we’ve seen before, let’s look at the meat of the <cite>main</cite>
function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">async</span> <span class="k">with</span> <span class="n">iterm2</span><span class="o">.</span><span class="n">CustomControlSequenceMonitor</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;shared-secret&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;^create-window$&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mon</span><span class="p">:</span>
</pre></div>
</div>
<p>This is how you use an asyncio context manager.</p>
<p><cite>iterm2.CustomControlSequenceMonitor</cite> is a special kind of class that defines
a context manager. That means it can perform an asyncio operation when it is
created and when the context ends.</p>
<p>This particular context manager registers a hook for custom control sequences.
Terminal emulators work by processing out-of-band messages called control
sequences to perform actions such as to move the cursor, clear the screen, or
change the current text color. Custom control sequences allow you to define your
own actions to perform when a control sequence you define is received.</p>
<p>When you use a context manager this way the flow of control enters the body of
the context manager (beginning with <cite>while True</cite>).</p>
<p>The <cite>async_get</cite> call blocks until a control sequence matching the requested
identity and payload are received. It returns a <cite>re.Match</cite> object, which is
the result of searching the control sequence’s payload with the regular
expression that the <cite>CustomControlSequenceMonitor</cite> was initialized with.</p>
<p>To produce a custom escape sequence, you could run this at the command line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">printf</span> <span class="s2">&quot;\033]1337;Custom=id=%s:%s\a&quot;</span> <span class="s2">&quot;shared-secret&quot;</span> <span class="s2">&quot;create-window&quot;</span>
</pre></div>
</div>
<p>The first argument, <cite>shared-secret</cite> is the identity and the second argument,
<cite>create-window</cite> is the payload. Here’s the body of the context manager:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">await</span> <span class="n">mon</span><span class="o">.</span><span class="n">async_get</span><span class="p">()</span>
    <span class="n">await</span> <span class="n">iterm2</span><span class="o">.</span><span class="n">Window</span><span class="o">.</span><span class="n">async_create</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
</pre></div>
</div>
<p>After receiving a matching control sequence, this example creates a new window.</p>
<p>If you wanted the payload to take more information, such as the number of
windows to create, you could use the regular expression matcher to capture
that value in a capture group and retrieve it from the matcher in the callback.</p>
<p>The control sequence remains registered even after <cite>main</cite> returns.</p>
<p>Finally, we get to the last line of the script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">iterm2</span><span class="o">.</span><span class="n">run_forever</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>This starts the script and keeps it running even after <cite>main</cite> returns so it can
continue to process custom control sequences until iTerm2 terminates. This is
what makes it a long-running daemon.</p>
<p>If you want to run multiple context managers concurrently, such as to register
two different custom control sequences, you need to create tasks that run in the
background. Otherwise, the flow of control will get stuck in the first one since
its body has a <cite>while True</cite> infinite loop. Here’s how you do that:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">wrapper</span><span class="p">():</span>
    <span class="n">async</span> <span class="k">with</span> <span class="n">iterm2</span><span class="o">.</span><span class="n">CustomControlSequenceMonitor</span><span class="p">(</span>
            <span class="n">connection</span><span class="p">,</span> <span class="n">identity</span><span class="p">,</span> <span class="n">regex</span><span class="p">)</span> <span class="k">as</span> <span class="n">mon</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">DoSomething</span><span class="p">(</span><span class="n">await</span> <span class="n">mon</span><span class="o">.</span><span class="n">async_get</span><span class="p">())</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">wrapper</span><span class="p">())</span>
<span class="c1"># Define more wrappers and create more tasks</span>
</pre></div>
</div>
<p>As you browse the documentation you will find many different context managers
that allow you to perform actions when something hapens. For example:</p>
<ul class="simple">
<li><a class="reference internal" href="../focus.html#iterm2.focus.FocusMonitor" title="iterm2.focus.FocusMonitor"><code class="xref py py-class docutils literal notranslate"><span class="pre">iterm2.focus.FocusMonitor</span></code></a></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">iterm2.keyboard.KeystrokeMonitor</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">iterm2.lifecycle.LayoutChangeMonitor</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">iterm2.lifecycle.NewSessionMonitor</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">iterm2.prompt.PromptMonitor</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">iterm2.screen.ScreenStreamer</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">iterm2.lifecycle.SessionTerminationMonitor</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">iterm2.variables.VariableMonitor</span></code></li>
</ul>
<p>Continue to the next section, <a class="reference internal" href="rpcs.html"><span class="doc">RPCs</span></a>.</p>
<hr class="docutils" />
<div class="section" id="other-sections">
<h2>Other Sections<a class="headerlink" href="#other-sections" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><dl class="first docutils">
<dt><a class="reference internal" href="../index.html"><span class="doc">Python API</span></a></dt>
<dd><ul class="first last">
<li><a class="reference internal" href="index.html"><span class="doc">Python API Introduction</span></a></li>
<li><a class="reference internal" href="example.html"><span class="doc">Example Script</span></a></li>
<li><a class="reference internal" href="running.html"><span class="doc">Running a Script</span></a></li>
<li>Daemons</li>
<li><a class="reference internal" href="rpcs.html"><span class="doc">RPCs</span></a></li>
<li><a class="reference internal" href="hooks.html"><span class="doc">Hooks</span></a></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
</div>
<div class="section" id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><a class="reference internal" href="../genindex.html"><span class="std std-ref">Index</span></a></li>
<li><a class="reference internal" href="../search.html"><span class="std std-ref">Search Page</span></a></li>
</ul>
</div>


	  </div>
	</div>
      </div>
    </div>
  </div>
</div>

<script src="https://iterm2.com/js/scripts.js"></script>                
<script type="text/javascript">
  function showId(id) {
    document.getElementById("changelist" + id).style.display = 'block';
    document.getElementById("show" + id).style.display = 'none';
    document.getElementById("hide" + id).style.display = 'inline';
  }

  function hideId(id) {
    document.getElementById("changelist" + id).style.display = 'none';
    document.getElementById("show" + id).style.display = 'inline';
    document.getElementById("hide" + id).style.display = 'none';
  }
  $(document).foundation();
</script>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, George Nachman.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
      |
      <a href="../_sources/tutorial/daemons.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>